name: Warp bootstrap
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  make-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add auto-apply workflows, scripts, labels, CODEOWNERS
        run: |
          mkdir -p .github/workflows .github/scripts

          cat > .github/workflows/warp-apply-from-issue.yml <<'YAML'
          name: Warp apply from issue comment

          on:
            issue_comment:
              types: [created]

          permissions:
            contents: write
            pull-requests: write
            issues: read
            metadata: read

          jobs:
            apply:
              if: contains(github.event.comment.body, '```diff')
              runs-on: ubuntu-latest
              steps:
                - name: Checkout
                  uses: actions/checkout@v4

                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: '20'

                - name: Extract diff block
                  run: node .github/scripts/extract-diff-from-comment.js
                  env:
                    COMMENT_BODY: ${{ github.event.comment.body }}

                - name: Validate allowed paths
                  run: node .github/scripts/validate-allowed-paths.js patch.diff

                - name: Apply patch to working tree
                  run: |
                    git config user.name "warp-bot"
                    git config user.email "warp-bot@users.noreply.github.com"
                    git apply -p0 patch.diff

                - name: Create PR
                  uses: peter-evans/create-pull-request@v6
                  with:
                    branch: warp/auto/${{ github.run_id }}-${{ github.run_number }}
                    title: "ci: Warp auto-apply patch to PR (safe paths only)"
                    commit-message: "ci(warp): apply patch from issue comment"
                    labels: "warp-auto,safe-ci-docs"
                    body: |
                      This PR was created automatically from an issue comment containing a fenced diff.

                      Safeguards:
                      - Allowed paths only: test/**, tools/**, .github/**, docs/**, openapi/**, fixtures/**
                      - CODEOWNERS protects runtime (src/**) and requires human review
                      - Auto-merge remains disabled unless enabled manually in repo settings

                      Please review and merge when CI is green.
          YAML

          cat > .github/workflows/warp-apply-manual.yml <<'YAML'
          name: Warp apply (manual)

          on:
            workflow_dispatch:
              inputs:
                patch:
                  description: "Unified diff content"
                  required: true
                  type: string

          permissions:
            contents: write
            pull-requests: write
            issues: read
            metadata: read

          jobs:
            apply:
              runs-on: ubuntu-latest
              steps:
                - name: Checkout
                  uses: actions/checkout@v4
                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: '20'
                - name: Extract diff block (manual)
                  run: node .github/scripts/extract-diff-from-comment.js
                  env:
                    PATCH_INPUT: ${{ github.event.inputs.patch }}
                - name: Validate allowed paths
                  run: node .github/scripts/validate-allowed-paths.js patch.diff
                - name: Apply patch
                  run: |
                    git config user.name "warp-bot"
                    git config user.email "warp-bot@users.noreply.github.com"
                    git apply -p0 patch.diff
                - name: Create PR
                  uses: peter-evans/create-pull-request@v6
                  with:
                    branch: warp/auto/${{ github.run_id }}-${{ github.run_number }}
                    title: "ci: Warp auto-apply patch to PR (safe paths only)"
                    commit-message: "ci(warp): apply patch via manual dispatch"
                    labels: "warp-auto,safe-ci-docs"
                    body: |
                      This PR was created via the manual warp-apply workflow (pasted unified diff).

                      Safeguards:
                      - Allowed paths only: test/**, tools/**, .github/**, docs/**, openapi/**, fixtures/**
                      - CODEOWNERS protects runtime (src/**) and requires human review
                      - Auto-merge remains disabled unless enabled manually in repo settings

                      Please review and merge when CI is green.
          YAML

          cat > .github/scripts/extract-diff-from-comment.js <<'JS'
          // Extract the first fenced ```diff block from COMMENT_BODY or accept raw PATCH_INPUT.
          import { writeFileSync } from 'node:fs';

          const body = process.env.PATCH_INPUT ?? process.env.COMMENT_BODY ?? '';
          const fence = /```diff\s*([\s\S]*?)```/m;
          let diffText = null;

          const m = fence.exec(body);
          if (m && m[1]) {
            diffText = m[1].trim();
          } else if (process.env.PATCH_INPUT) {
            diffText = process.env.PATCH_INPUT.trim();
          }

          if (!diffText) {
            console.error('No diff block found in input.');
            process.exit(1);
          }

          writeFileSync('patch.diff', diffText, 'utf8');
          console.log('patch.diff written');
          JS

          cat > .github/scripts/validate-allowed-paths.js <<'JS'
          // Validate file paths in a unified diff against an allow-list.
          import { readFileSync } from 'node:fs';

          const allowPrefixes = ['test/', 'tools/', '.github/', 'docs/', 'openapi/', 'fixtures/'];
          const patchPath = process.argv[2] || 'patch.diff';
          const text = readFileSync(patchPath, 'utf8');

          const files = new Set();
          for (const line of text.split(/\r?\n/)) {
            let m = /^diff --git a\/(.+?) b\/(.+)$/.exec(line);
            if (m) {
              if (m[1] !== '/dev/null') files.add(m[1]);
              if (m[2] !== '/dev/null') files.add(m[2]);
              continue;
            }
            m = /^--- a\/(.+)$/.exec(line);
            if (m && m[1] !== '/dev/null') { files.add(m[1]); continue; }
            m = /^\+\+\+ b\/(.+)$/.exec(line);
            if (m && m[1] !== '/dev/null') { files.add(m[1]); continue; }
          }

          const disallowed = [];
          for (const f of files) {
            if (!f) continue;
            const ok = allowPrefixes.some((p) => f.startsWith(p));
            if (!ok) disallowed.push(f);
          }

          if (disallowed.length) {
            console.error('Disallowed paths in patch:', disallowed.join(', '));
            process.exit(1);
          }
          console.log('All paths allowed:', Array.from(files).join(', '));
          JS

          cat > .github/labeler.yml <<'YAML'
          safe-ci-docs:
            - 'test/**'
            - 'tools/**'
            - '.github/**'
            - 'docs/**'
            - 'openapi/**'
            - 'fixtures/**'
          warp-auto:
            - '.github/workflows/warp-apply-*.yml'
            - '.github/scripts/**'
          YAML

          cat > .github/CODEOWNERS <<'TXT'
          # Protect runtime: require human review for any changes under src/**
          /src/ @paulslee

          # Tests/CI/tools/docs may be auto-proposed but still require checks to pass.
          /test/ @paulslee
          /tools/ @paulslee
          /.github/ @paulslee
          /docs/ @paulslee
          /openapi/ @paulslee
          /fixtures/ @paulslee
          TXT

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ci/warp-auto-apply
          title: "ci: Warp auto-apply patch to PR (safe paths only)"
          commit-message: "ci(warp): bootstrap auto-apply workflows, scripts, labels and CODEOWNERS"
          labels: "warp-auto,safe-ci-docs"
          body: |
            This PR bootstraps Warpâ€™s auto-apply system:
            - .github/workflows/warp-apply-from-issue.yml
            - .github/workflows/warp-apply-manual.yml
            - .github/scripts/extract-diff-from-comment.js
            - .github/scripts/validate-allowed-paths.js
            - .github/labeler.yml
            - .github/CODEOWNERS

            Safe paths only (tests/CI/tools/docs/openapi/fixtures). Runtime (src/**) protected by CODEOWNERS.
